
/* Controltag Loader for Washington Post */
(function(){
  function debugLog(msg) {
    var isDebug = /kxdebug=(1|true)/.test(location);
    if (isDebug && typeof window.console === 'object' && typeof console.info === 'function') {
      console.info(msg);
    }
  }

  function loadCT(url, callback) {
    debugLog('Loading Krux control tag.');
    var ct_element = document.createElement('script');
    ct_element.async = true;
    ct_element.src = url;

    ct_element.onload = ct_element.onreadystatechange = function() {
      var state = ct_element.readyState;
      if (!callback.done && (!state || /loaded|complete/.test(state))) {
        callback.done = true;
        callback();
      }
    };

    // Fetch the first script element, so we can insert the
    // controltag before it. There *must* be at least one
    // script element, or this code would never be called
    var sibling = document.getElementsByTagName('script')[0];
    sibling.parentNode.insertBefore(ct_element, sibling);
  };

  function loadConfig() {
    
    
    debugLog('Loading krux configuration.');
    Krux( 'config', {"confid": "IbWIJ0xh", "context_terms": [{"id": "It03V-vk", "value": "visa signature"}, {"id": "It03WASn", "value": "credit card"}, {"id": "It03WAvJ", "value": "nissan maxima"}], "dnt": null, "geo":{"COUNTRY":"IN", "REGION":"KA", "CITY":"BANGALORE", "GEOREGION":"104", "DMA":"", "PMSA":"", "AREACODE":"", "COUNTY":"", "FIPS":"", "LATITUDE":"12.98", "LONGITUDE":"77.58", "TIMEZONE":"GMT 5.50", "ZIP":"", "CONTINENT":"AS"}, "params": {"beacon_host": "beacon.krxd.net", "capture_js_errors": "true", "capture_leakage": true, "client_side_storage": "localStorage,cookie", "context_terms": "true", "control_tag_load_sync": "false", "control_tag_namespace": null, "control_tag_pixel_throttle": "100", "control_tag_stats_prefix": null, "control_tag_version": "stable", "datatag_version": "3", "jslog_host": "jslog.krxd.net", "max_slot_time": 1000, "no_pii": 0, "revenue_optimization": false, "services_host": "apiservices.krxd.net", "site_level_supertag_config": "site", "supertag_requires_approval": false}, "partner_segment_map": {}, "publisher": {"id": 11974, "name": "Washington Post", "uuid": "415dda7b-13ba-40f3-9a60-eb3ba310f160"}, "realtime_segments": [{"id": "niv0ol064", "test": ["and", ["or", ["and", ["or", ["intersects", "$page_attr_wp_section", "[\"entertainment\"]"]]]]]}], "segments": [], "services": {"data": "//beacon.krxd.net/data.gif", "event": "//beacon.krxd.net/event.gif", "log": "//jslog.krxd.net/jslog.gif", "pixel": "//beacon.krxd.net/pixel.gif", "social": "//beacon.krxd.net/social.gif", "stats": "//apiservices.krxd.net/stats", "um": "//apiservices.krxd.net/um", "userData": "//apiservices.krxd.net/user_data/segments/3"}, "site": {"id": 14227, "name": "Washington Post"}, "tags": [{"content": "<script type=\"text/javascript\">Krux('social.init');</script>", "content_type": "html", "docwrite": null, "execution_results": null, "id": 24879, "internal": 1, "library_tag_config": {}, "method": "document", "name": "Krux Track Social", "require": "", "target": null, "target_action": "append", "tier": 1, "timing": "onload", "type": "library"}, {"content": "<script>\r\n(function(){\r\n  if (window.KRUX) {\r\n    var pubid = KRUXSetup.pubid;\r\n  } else if (window.Krux) {\r\n    var pubid = Krux('get', 'pubid');\r\n  } else { \r\n    return;\r\n  }\r\n  var prefix = location.protocol == 'https:' ? \"https:\" : \"http:\";\r\n  var kurl = prefix + '//beacon.krxd.net/data.gif?_kdpid=890a6228-04af-4630-85b6-0b49dee6157f&pid=' + pubid;\r\n  var u = prefix + '//api.bizographics.com/v1/profile.redirect?api_key=595bae8dbc0c4c42b4544e688b10c002' + \r\n        '&callback_url=' + escape(kurl);\r\n  var i = new Image();\r\n  i.src = u;\r\n})();\r\n</script>", "content_type": "html", "docwrite": null, "execution_results": null, "freq_cap": 3, "id": 23155, "internal": 2, "method": "document", "name": "Bizo provider tag", "require": "", "target": null, "target_action": "append", "tier": 1, "timing": "onload", "type": "data provider"}, {"content": "<script type=\"text/javascript\">\r\n  Krux('dataprovider.exelate');\r\n</script>", "content_type": "html", "docwrite": null, "execution_results": null, "freq_cap": 3, "id": 23156, "internal": 11, "method": "document", "name": "eXelate Media provider tag", "require": "", "target": null, "target_action": "append", "tier": 1, "timing": "onload", "type": "data provider"}, {"content": "<script>\r\n// this tag is intentionally blank\r\n</script>", "content_type": "html", "docwrite": null, "execution_results": null, "freq_cap": 3, "id": 22656, "internal": 6, "method": "document", "name": "Technographic Data provider tag", "require": "", "target": null, "target_action": "append", "tier": 1, "timing": "onload", "type": "data provider"}, {"content": "", "content_type": "html", "docwrite": null, "execution_results": null, "freq_cap": 3, "id": 22657, "internal": 14, "method": "document", "name": "Krux Geographic Data provider tag", "require": "", "target": null, "target_action": "append", "tier": 1, "timing": "onload"}, {"content": "<script>\r\n(function() {\r\n  // adadvisor redirects to http://logger... so it's not https safe\r\n  if (location.protocol == \"http:\") {\r\n     var u = \"https://adadvisor.net/adscores/g.js?sid=9212244187&_kdpid=2111c0af-fc3a-446f-ab07-63aa74fbde8e\";\r\n     (new Image()).src = u;\r\n   }\r\n})();\r\n</script>", "content_type": "html", "docwrite": null, "execution_results": null, "freq_cap": 3, "id": 23427, "internal": 22, "method": "document", "name": "AdAdvisor S2S provider tag", "require": "", "target": null, "target_action": "append", "tier": 1, "timing": "onload", "type": "data provider"}, {"content": "<script>\r\n  Krux('require:http').pixel({\r\n    url: \"//s.ixiaa.com/digi/C726AB29-0470-440B-B8D2-D552CED3A3DC/a.gif\"\r\n  });\r\n</script>", "content_type": "html", "docwrite": null, "execution_results": null, "freq_cap": 3, "id": 23428, "internal": 28, "method": "document", "name": "IXI Digital (Open Market) provider tag", "require": "", "target": null, "target_action": "append", "tier": 1, "timing": "onload", "type": "data provider"}, {"content": "<script>\r\n(function(){\r\n  var kuid = Krux('get', 'user');\r\n  if (kuid) {\r\n    Krux('require:http').pixel({\r\n      url: \"//krxd.nexac.com/dlx.gif\",\r\n      data: {\r\n          _kdpid: '2dd640a6-6ebd-4d4f-af30-af8baa441a0d',\r\n          kuid: kuid\r\n      }});\r\n  }\r\n  })();\r\n</script>", "content_type": "html", "docwrite": null, "execution_results": null, "freq_cap": 3, "id": 23429, "internal": 8, "method": "document", "name": "DataLogix provider tag", "require": "", "target": null, "target_action": "append", "tier": 1, "timing": "onload", "type": "data provider"}, {"content": "<script>\r\n(function(){\r\n  var kuid = Krux('get', 'user');\r\n  if (kuid) {\r\n    Krux('require:http').pixel({\r\n      url: \"//p.acxiom-online.com/pixel/sci\",\r\n      data: {\r\n          uid: kuid,\r\n          _kdpid: 'f19b7626-3732-4dcc-bac5-8d2c937dae9a',\r\n          pid: 3021\r\n      }});\r\n  }\r\n  })();\r\n</script>", "content_type": "html", "docwrite": null, "execution_results": null, "freq_cap": 3, "id": 23255, "internal": 21, "method": "document", "name": "Acxiom S2S provider tag", "require": "", "target": null, "target_action": "append", "tier": 1, "timing": "onload", "type": "data provider"}, {"content": "<script>\r\n// Using Meta keywords to produce page attribute keywords\r\nKrux('scrape', { \"page_attr_keywords\": {meta_name: \"keywords\"}});\r\n// Using Omniture prop34 to produce page attribute omniture_prop34\r\nKrux('set', 'page_attr_omniture_prop34', typeof window.s =='object' && window.s['prop34']);\r\n// Using Globals wp_section to produce page attribute wp_section\r\nKrux('scrape', { \"page_attr_wp_section\": {js_global: \"wp_section\"}});\r\n// Using Globals wp_subsection to produce page attribute wp_subsection\r\nKrux('scrape', { \"page_attr_wp_subsection\": {js_global: \"wp_subsection\"}});\r\n// Using Globals wp_content_category to produce page attribute wp_content_category\r\nKrux('scrape', { \"page_attr_wp_content_category\": {js_global: \"wp_content_category\"}});\r\n// Using Globals wp_meta_data.wt to produce page attribute wp_meta_data.wt\r\nKrux('scrape', { \"page_attr_wp_meta_data.wt\": {js_global: \"wp_meta_data.wt\"}});\r\n// Using Cookie rplm to produce page attribute cookie_rplm\r\nKrux('scrape', { \"page_attr_cookie_de\": {cookie: \"de\"}});\r\n\r\n// Set section/subsection\r\n  Krux('set', {\r\n    section: Krux('get', 'page_attr_wp_section'),\r\n    subsection: Krux('get', 'page_attr_wp_subsection')\r\n  });\r\n\r\n</script>", "content_type": "html", "docwrite": null, "execution_results": {"docwrite": false, "listeners": [], "onloadSafe": true}, "id": 23049, "internal": 1, "method": "document", "name": "Krux Data Transfer Code", "require": "", "target": "", "target_action": null, "tier": 1, "timing": "onload", "type": "publisher"}, {"content": "<script type='text/javascript' \r\n        src='http://pixel.mathtag.com/sync/js?sync=auto'>\r\n</script>", "content_type": "html", "docwrite": null, "execution_results": null, "id": 27033, "internal": false, "method": "document", "name": "MediaMath User Match", "require": "", "target": "", "target_action": null, "tier": 1, "timing": "onload", "type": "publisher"}, {"content": "<script>\r\n// Using Globals commercialNode to produce page attribute commercialnode\r\nKrux('scrape', { \"page_attr_commercialnode\": {js_global: \"commercialNode\"}});\r\n</script>", "content_type": "html", "docwrite": null, "execution_results": null, "id": 23533, "internal": 1, "method": "document", "name": "Krux Data Transfer Code - Commercial Node", "require": "", "target": "", "target_action": null, "tier": 1, "timing": "onload", "type": "publisher"}, {"content": "<script type=\"text/javascript\">\r\n// DFP premium\r\n(function(require) {\r\n  var store = require('store');\r\n  var _ = require('util');  \r\n  var segments;\r\n  \r\n  function handleUserDataResponse(r) {\r\n    // Handle the response as usual.\r\n    segments.handleUserDataResponse(r);\r\n    \r\n    // Override localStorage.kxuser with a case-insensitive value for DFP premium.\r\n    // This will get read by the interchange direct snippet for Krux.user\r\n    // and Krux.dfpKeyValues\r\n    if(r.kuid_long) {\r\n      store.set('user', r.kuid_long, store.DAYS*30);\r\n    }\r\n  }\r\n  \r\n  // Our own fetch uses our own handleResponse\r\n  function fetch() {\r\n    var options = {\r\n      url: _.get('url_userData'),\r\n      data: {pubid: _.get('pubid')},\r\n      callback: 'kxjsonp_userData',\r\n      done: handleUserDataResponse\r\n    };\r\n    if(!segments.readTechFromStore()) {\r\n      options.data.technographics = 1;\r\n    }\r\n    require('http').jsonp(options);  \r\n  }\r\n  \r\n  \r\n  if(!store.get('segWait')) {\r\n    // disable segments.fetch and use our own\r\n    _.set('segWait', 1, store.MINUTES*5);\r\n    _.onOnce('dom:load', fetch);\r\n    _.fire('user_data_fetch_scheduled');\r\n  }\r\n  \r\n  // Finally, require segments as usual.\r\n  segments = require('segments');\r\n}(Krux.require));\r\n</script>", "content_type": "html", "docwrite": null, "execution_results": null, "id": 22658, "internal": 1, "library_tag_config": {}, "method": "document", "name": "Krux Load Segments v2", "require": "", "target": "", "target_action": null, "tier": 2, "timing": "onload", "type": "library"}, {"content": "<script>\r\n(function () {\r\n    function getCookie(c_name) {\r\n        var c_value = document.cookie;\r\n        var c_start = c_value.indexOf(c_name + \"=\");\r\n        if (c_start == -1) {\r\n            c_start = c_value.indexOf(c_name + \"=\");\r\n        }\r\n        if (c_start == -1) {\r\n            c_value = null;\r\n        } else {\r\n            c_start = c_value.indexOf(\"=\", c_start) + 1;\r\n            var c_end = c_value.indexOf(\";\", c_start);\r\n            if (c_end == -1) {\r\n                c_end = c_value.length;\r\n            }\r\n            c_value = unescape(c_value.substring(c_start, c_end));\r\n        }\r\n        return c_value;\r\n    }\r\n\r\n    var wpatc = getCookie(\"WPATC\");\r\n    if (wpatc != null && wpatc != \"\") {\r\n        var n = wpatc.split(\":\");\r\n        for (i = 0; i < n.length; i++) {\r\n            // get attribute pairs\r\n            var attribute = n[i].toUpperCase();\r\n            var split_value = attribute.split(\"=\");\r\n\r\n            switch (split_value[0]) {\r\n                case \"A\":\r\n                    // set attribute of A\r\n                    var value = split_value[1];\r\n                    Krux('set', {\r\n                        'user_attr_A': value\r\n                    });\r\n                    break;\r\n                case \"B\":\r\n                    // set attribute of B AND KEEP reading\r\n                    var value = split_value[1];\r\n                    if (value < 25) {\r\n                        Krux('set', {\r\n                            'user_attr_B_Job': value\r\n                        });\r\n                    } else if (value >= 25 && value <= 59) {\r\n                        Krux('set', {\r\n                            'user_attr_B_Responsibility': value\r\n                        });\r\n                    } else if (value >= 60 && value <= 99) {\r\n                        Krux('set', {\r\n                            'user_attr_B_Industry': value\r\n                        });\r\n                    } else if (value >= 100 && value <= 110) {\r\n                        Krux('set', {\r\n                            'user_attr_B_Size': value\r\n                        });\r\n                    }\r\n                   case \"D\":\r\n                    value = split_value[1];\r\n                    if (value >= 1 && value <= 5) {\r\n                    Krux('set', {\r\n                        'user_attr_D': value\r\n                    });\r\n                    break;\r\n                    }\r\n            }\r\n        }\r\n    }\r\n})();\r\n</script>", "content_type": "html", "docwrite": null, "execution_results": {"docwrite": false, "listeners": [], "onloadSafe": true}, "id": 27248, "internal": 1, "method": "document", "name": "WPATC Ingest", "require": "", "target": "", "target_action": null, "tier": 1, "timing": "onready", "type": "publisher"}]} );
    
  };

  loadCT( "//cdn.krxd.net/ctjs/controltag.js.8d3bee8c7187eef6171bab2ef474f38d", loadConfig );
})();
